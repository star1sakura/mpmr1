# 要求二实现方案（与 r1 新模型对齐）

本文档面向使用者，说明如何基于 r1 最新模型输出完成“要求二”的方法对比与结果生成。已确保与当前 `r1/` 目录结构一致。

---

## 1. 目标

比较两种合并机制在历史赛季中的表现：

- **CBR（Combined by Rank）**：排名合并法
- **CBP（Combined by Percentage）**：百分比合并法

核心输出包括：淘汰一致性（EMR/B2CR）、翻转率（Flip Rate）、争议选手画像与可视化图表。

---

## 2. 数据来源与字段说明

默认使用 r1 最新输出：

- `r1/outputs/req1_vote_estimates.csv`

要求字段（r2 实际使用）：

- `season`、`week`
- `contestant_id`（用于稳定性 tie-break）
- `celebrity_name`
- `J_total`（评审总分）
- `p_hat`（粉丝投票份额估计）
- `eliminated`（当周淘汰标记）

说明：

- **r2 不做额外插值或补全**，直接使用 r1 输出。
- 若某周没有淘汰记录，会被自动跳过计分。
- `req1_features.csv` 也可作为输入（字段更丰富），但需保证包含上述字段。

---

## 3. 规则定义与计算逻辑

### 3.1 CBR（排名合并）

- 评审排名：`R_J` = 对 `J_total` 降序排名（并列使用平均秩）
- 粉丝排名：`R_V` = 对 `p_hat` 降序排名（并列使用平均秩）
- 合并得分：

```text
S_CBR = R_J + R_V
```

- 淘汰规则：`S_CBR` 最大者淘汰；若 judge-save 赛季，取 `S_CBR` 最大的两人作为 Bottom-2

### 3.2 CBP（百分比合并）

- 评审占比：`P_J = J_total / sum(J_total)`
- 粉丝占比：`P_V = p_hat`
- 合并得分：

```text
S_CBP = P_J + P_V
```

- 淘汰规则：`S_CBP` 最小者淘汰；若 judge-save 赛季，取最小两人作为 Bottom-2

### 3.3 Tie-break 规则

- 所有并列情况用 `contestant_id` 做稳定性 tie-break（与代码一致，保证可复现）。

---

## 4. 指标定义

### 4.1 EMR（Elimination Match Rate）

- 适用：无 judge-save 赛季
- 定义：实际淘汰者是否与方法预测淘汰者一致

### 4.2 B2CR（Bottom-2 Coverage Rate）

- 适用：judge-save 赛季
- 定义：实际淘汰者是否落入预测的 Bottom-2 集合

### 4.3 Flip Rate（翻转率）

- 定义：CBR 与 CBP 对淘汰（或 Bottom-2）预测是否发生差异

---

## 5. 输出文件说明（r2/outputs）

- `method_comparison.csv`
  - 每周对比结果：实际淘汰、CBR/CBP 预测、命中情况
- `season_method_metrics.csv`
  - 赛季级指标：CBR_EMR/CBP_EMR/CBR_B2CR/CBP_B2CR/flip_rate
- `flip_events.csv`
  - 发生预测分歧的周次详细记录（含 flip_driver）
- `flip_strength.csv`
  - 翻转强度明细（淘汰者在对方规则中的排名距离）
- `flip_uncertainty.csv`
  - 每周不确定性与翻转信息的汇总表
- `flip_uncertainty_summary.csv`
  - 不确定性分箱后的翻转率/强度汇总
- `uncertainty_focus.csv`
  - 高/低不确定性周次的指标对比
- `controversy_analysis.csv`
  - 争议选手（Jerry/Billy/Bristol/Bobby）的逐周指标（新增 `judge_share`、`fan_judge_gap`）
- `flip_rate_by_season.png`
  - 赛季翻转率图
- `flip_strength.png`
  - 翻转强度分布（按是否 judge-save 分组）
- `flip_uncertainty_rate.png`
  - 不确定性分箱下的翻转率对比
- `flip_uncertainty_strength.png`
  - 不确定性分箱下的翻转强度对比
- `uncertainty_focus.png`
  - 高/低不确定性周次的翻转率与强度对比
- `emr_by_season.png`
  - 无 judge-save 赛季的 EMR 对比图
- `b2cr_by_season.png`
  - judge-save 赛季的 B2CR 对比图
- `controversy_gap_trends.png`
  - 争议选手的 fan_judge_gap 趋势（四宫格）
- `summary.md`
  - 自动汇总结论（典型赛季、整体指标、争议选手解读）
- `summary_table.csv`
  - 关键指标与典型赛季的结构化汇总表
- `decision_guidance.csv`
  - 赛季规则建议表（基于 EMR/B2CR 差距与 tie 阈值）
- `tie_sensitivity.csv`
  - tie 阈值敏感性统计表
- `strata_metrics.csv`
  - 分层指标表（按参赛人数与赛季阶段）
- `strata_by_size.png`
  - 规模分层下的 CBR/CBP 对比图
- `strata_by_stage.png`
  - 赛季阶段分层下的 CBR/CBP 对比图
- `summary_metrics.png`
  - 全局 CBR/CBP 指标对比图
- `summary_flip_strength.png`
  - 全局翻转强度对比图
- `tie_sensitivity.png`
  - tie 阈值敏感性分布图

---

## 6. 运行方式

默认使用 r1 最新输出：

```bash
python r2/req2_analysis.py
```

指定输入文件：

```bash
python r2/req2_analysis.py --votes r1/outputs/req1_vote_estimates.csv
```

输出目录（默认）：

- `r2/outputs/`

---

## 7. 与 r1 新模型的一致性说明

r2 的输入已与 r1 最新模型对齐：

- r1 使用“人气先验 + 评审表现 + 惯性”的可解释先验
- 排名赛季采用 ILP 严格满足 rank-sum 约束
- judge-save 赛季采用 Bottom-2 规则
- `uncertainty_width` 用于稳健性与分层分析（不确定性分箱/高低对比）

因此，r2 的方法对比基于 **更新后的 p_hat**，与旧模型数据已不一致；必须重新生成 r2 输出以保证一致性。

---

## 8. 解读建议与常见注意点

- **Flip Rate 高**：说明两种规则对淘汰结果分歧较大，适合用作“制度差异”证据。
- **B2CR 不等于淘汰准确率**：judge-save 赛季评价标准是“是否落入 Bottom-2”。
- `p_hat` 为相对份额，跨周/跨季不可直接相加。
- 若某周缺失淘汰记录，该周不会进入统计分母。
- 翻转来源（judge/fan/mixed）基于 **rank 差异方向** 定义，用于定性解释制度差异，并非因果结论。
- 翻转强度基于“淘汰者在对方规则中的排名距离”计算；judge-save 赛季使用**最差者**作为代表。
- `decision_guidance.csv` 的 tie 判定阈值为 0.05（可在脚本中调整）。
- 不确定性分析使用 `uncertainty_width` 的分位数分箱（low/mid/high）。
- 高/低不确定性聚焦使用 top 25% / bottom 25% 分位数。
- 分层分析使用参赛人数与周次的分位数分箱（small/mid/large 与 early/mid/late）。
- tie 阈值敏感性默认使用 0.03/0.05/0.07。

---

## 9. 可扩展项（未实现）

以下扩展不在当前版本实现，仅供后续需要时考虑：

- 将 tie 阈值敏感性扩展为连续曲线
- 引入更多争议选手与职业/题材分层分析
- 对不同权重组合进行反事实模拟
