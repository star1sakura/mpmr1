《与星共舞》问题三实现方案（可落地版）

1. 目标
   围绕名人特征与专业舞伴的影响，分别解释评审评分与粉丝偏好，并进一步分析选手“存活周数/进入决赛”的综合表现。

2. 数据与字段
   主数据：req1_features.csv（如缺失则使用 req1_vote_estimates.csv）。
   核心字段：

- season, week
- celebrity_name, ballroom_partner
- celebrity_age_during_season（年龄）
- celebrity_industry
- celebrity_homestate（州）
- celebrity_homecountry/region（国家/地区）
- J_total（评审总分）
- p_hat（粉丝投票份额）
- eliminated（淘汰标记）

备注：性别字段若不存在，不建议通过姓名推断。需要时仅在有可靠外部来源时补充。

3. 特征工程
   3.1 区域归并

- 使用 homecountry/region + homestate 联合映射：
  - 非美国选手统一标记为 International
  - 美国选手按 Northeast/Midwest/South/West 归并
  - 缺失或无法映射标记为 Unknown

  3.2 标准化与综合指标

- 评审分数按 season-week 标准化：J_z
- 粉丝投票份额裁剪到 (0,1)：p_hat_clip
- age/ week 做 z-score 方便跨模型比较
- 存活周数：每位选手最后一次出现的 week
- 是否进入决赛：按赛季最后一周在赛选手作为“入围”

  3.3 分类变量处理

- Industry 与 Ballroom_Partner 作为高维类别，优先用于混合效应模型的随机效应；若需固定效应，做频次截断。

4. 模型设计
   4.1 评审评分模型（Model J）
   线性混合效应模型（LMM）：

- 因变量：J_z
- 固定效应：age_z、Region、Season、week_z
- 随机效应：Ballroom_Partner、Industry
  目的：量化技术评分与名人特征/舞伴效应的关系。

  4.2 粉丝投票模型（Model F）
  **Beta 混合效应模型（bambi/PyMC）**：

- 因变量：p_hat_clip（0-1）
- 固定效应：age_z、Region、Season、week_z
- 随机效应：Ballroom_Partner、Industry
  目的：在比例数据假设下量化观众偏好与名人特征/舞伴效应的关系。

  4.3 综合表现模型（Model P）
  两个层面：

- **Time-varying Cox**：周级 start-stop，事件=淘汰；按 season 分层；协变量包含 J_z、p_hat_z、age_z、Region/Industry
- 逻辑回归：目标=是否进入决赛（contestant-level 汇总）

  4.4 模型诊断与对比

- 诊断：LOO/WAIC + Pareto-k + PPC（分布与均值对比）
- 模型对比：Beta 模型简化对比（M0 vs M3）
  - M0：无随机效应
  - M3：舞伴 + 行业随机效应
- K-fold：按 contestant_key 分组，稀有区域固定留在训练集以避免新类别错误
- 可选参数（更稳健对比）：
  `--compare-models --compare-minimal --compare-folds 3 --compare-draws 2000 --compare-tune 2000 --compare-chains 4 --compare-target-accept 0.99`

5. 结果解读
   5.1 固定效应对比

- 对比 Model J 与 Model F 的系数方向与显著性，判断“评审偏好”与“粉丝偏好”是否一致
- 使用系数差异表（coef_diff_table.csv）进行近似显著性检验

  5.2 舞伴与行业效应

- 提取随机效应（BLUPs）或方差分量，识别对评分/投票有显著提升的舞伴或行业类别。

  5.3 综合结论

- 量化名人特征、舞伴效应在评审与粉丝两条路径中的差异机制，并给出解释性结论。

6. 输出清单

- `r3/outputs/interpretation_report.md`：论文式解读报告
- `r3/outputs/summary.md`：摘要页（自动生成）
- `r3/outputs/beta_fan_effects.csv`：粉丝投票 Beta 混合效应固定效应
- `r3/outputs/beta_marginal_effects.csv`：粉丝投票边际效应
- `r3/outputs/model_diagnostics.csv`：LOO/WAIC + Pareto-k 诊断摘要
- `r3/outputs/ppc_distribution.png` / `ppc_mean.png`：PPC 诊断图
- `r3/outputs/model_comparison.csv`：M0 vs M3 对比（LOO/K-fold）
- `r3/outputs/kfold_results.csv`：K-fold 每折 ELPD
- `r3/outputs/cox_model_summary_coef.csv`：Time-varying Cox 系数表

7. 软件与实现建议

- R：survival（coxph）、lme4（lmer）。
- Python：lifelines、statsmodels、bambi、pymc、arviz。
